# Envoy
Envoy 是一种 L7 代理和通信总线，专为大型面向服务的架构而设计。

**进程外架构**：
Envoy 是一个独立的进程，旨在与每个应用程序服务器一起运行。所有 Envoy 形成一个透明的通信网格，其中每个应用进程都在本地主机之间发送和接受消息，并且不知道网络拓扑。

与传统的方法相比，外进程架构有两个实质性好处：
1. 适用于任何应用程序语言。单个 Envoy 部署在各种语言等之间形成网格。
2. 任何使用大型面向服务架构的人都知道，部署升级会非常痛苦。 Envoy 可以透明地在整个基础设施中快速部署和升级。

**L3/L4 过滤器架构**：
核心是 L3/L4 网络代理。可插入的 过滤器 链机制允许编写过滤器来执行不同的 TCP/UDP 代理任务并插入到主服务器中。已经编写了过滤器以支持各种任务，例如原始 TCP代理 ，UDP代理，HTTP代理等。


**HTTP L7 过滤器架构**：
HTTP 是现代应用程序架构的关键组件，Envoy 支持额外的 HTTP L7 过滤器层。
HTTP 过滤器可以插入 HTTP 连接管理子系统，执行不同的任务，如 缓冲、速率限制、路由/转发等。


**一流的 HTTP/2 支持**：
在 HTTP 模式下运行，支持 **HTTP1.1** 和 **HTTP/2** 。

推荐的服务到服务的配置在所有 Envoy 之间使用 HTTP/2 来创建一个持久连接网络，请求和响应可以在该网格上多路复用。

**HTTP/3 支持**：
从 1.19.0 开始，支持 HTTP/3 上游和下游，并在 HTTP1.1 和 HTTP/2 和 HTTP/3 的任意组合之间进行双向转换。

- HTTP L7 路由：
- grpc 支持：
- 服务发现和动态配置：
- 健康检查：
- 高级负载均衡：
- 前端/边缘代理支持：
- 一流的可观察性：


## 架构

- 上游：接收 **Envoy** 的连接和请求并接受响应
- 下游：连接 Envoy，发送请求并接受响应
- 监听器： 一个命名的网络位置（例如，端口，unix域套接字等），下游客户端可以连接到它。Envoy公开了下游主机连接到的一个或多个监听器
- 集群：一组逻辑上相似的上游主机，Envoy 连接到这些主机。Envoy 连接到这些主机。通过服务发现集群的成员，可以选择通过主动健康检查来确定集群成员的健康状况。 Envoy 将请求路由到的集群成员由负载均衡策略决定
- 网状网络：一组协调以提供一致网络拓扑的主机
- 运行时配置：与 Envoy 一起部署的带外实时配置系统。可以更改配置设置以影响操作，而无需重新启动 Envoy 或者更改主要配置。


### 线程模型
使用单进程多线程架构。单个主线程控制各个零星的协调任务，而一些工作线程执行监听、过滤和转发。一旦连接被监听器接受，连接将在其剩余的生命周期中绑定到单个工作线程。

允许大部分 Envoy 基本上是单线程的，在工作线程之间有少量更复杂的代理处理协调。 **通常建议工作线程数量等于机器上的硬件线程数**。

### 监听器连接平衡
默认情况下，工作线程之间没有协调。意味着所有工作线程独立地尝试接受每个监听器上的连接，并依赖内核在线程之间执行充分的平衡。
对于大多数工作负载，内核在平衡传入连接方面做的非常好。
Envoy 允许在每个监听器上配置不同类型的连接平衡


## 监听

